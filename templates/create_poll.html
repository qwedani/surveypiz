{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<div class="poll-editor">
    <h2>Создание нового опроса</h2>
    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label>Название опроса</label>
            <input type="text" name="title" placeholder="Введите название опроса" required>
        </div>

        <div id="questions-container">

        </div>

        <button type="button" onclick="addQuestion()" class="btn">Добавить вопрос</button>
        <button type="submit" class="btn">Создать опрос</button>
    </form>
</div>

<script>
// Функция для авто-высоты textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// Инициализация авто-высоты для всех textarea
document.querySelectorAll('.question-textarea').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
    autoResize(textarea); // Инициализация при загрузке
});

// Добавление вопроса
function addQuestion() {
    const newQuestion = `
    <div class="question-card">
        <div class="question-header">
            <button type="button" class="delete-question-btn" onclick="removeQuestion(this)">×</button>
            <textarea class="question-textarea" name="question[]" placeholder="Текст вопроса" required></textarea>
            <select name="type[]">
                <option value="text">Текстовый вопрос</option>
                <option value="radio">Единичный выбор</option>
                <option value="checkbox">Множественный выбор</option>
            </select>
        </div>
        <div class="options-container" style="display: none;">
            <div class="options-list"></div>
            <button type="button" class="btn add-option-btn" onclick="addOption(this)">Добавить вариант</button>
            <input type="hidden" name="options[]" class="options-json">
        </div>
    </div>`;

    const container = document.getElementById('questions-container');
    container.insertAdjacentHTML('beforeend', newQuestion);

    // Инициализация авто-высоты для нового поля
    const newTextarea = container.lastElementChild.querySelector('.question-textarea');
    newTextarea.addEventListener('input', () => autoResize(newTextarea));
    autoResize(newTextarea);
}

// Добавление варианта
function addOption(button) {
    const optionsList = button.parentElement.querySelector('.options-list');
    const newOption = document.createElement('div');
    newOption.className = 'option';
    newOption.innerHTML = `
        <input type="text" class="option-input" placeholder="Введите вариант">
        <button type="button" class="delete-option-btn" onclick="removeOption(this)">×</button>
    `;
    optionsList.appendChild(newOption);
    updateOptionsJson(button.closest('.question-card'));
}

// Удаление варианта
function removeOption(button) {
    const option = button.closest('.option');
    option.remove();
    updateOptionsJson(button.closest('.question-card'));
}

// Обновление JSON
function updateOptionsJson(questionCard) {
    const inputs = questionCard.querySelectorAll('.option-input');
    const options = Array.from(inputs).map(input => input.value.trim());
    const jsonInput = questionCard.querySelector('.options-json');
    jsonInput.value = JSON.stringify(options);
}

// Удаление вопроса
function removeQuestion(button) {
    const questionCard = button.closest('.question-card');
    questionCard.remove();
}

// Drag and Drop
document.addEventListener('DOMContentLoaded', function() {
    addQuestion();
    new Sortable(document.getElementById('questions-container'), {
        animation: 150,
        handle: '.question-card',
        ghostClass: 'dragging-ghost'
    });
});

// Обработчик изменений типа вопроса (делегирование событий)
document.getElementById('questions-container').addEventListener('change', function(e) {
    if (e.target.matches('select[name="type[]"]')) {
        const questionCard = e.target.closest('.question-card');
        const optionsContainer = questionCard.querySelector('.options-container');
        optionsContainer.style.display = ['radio', 'checkbox'].includes(e.target.value)
            ? 'block'
            : 'none';
    }
});

// Инициализация при загрузке
document.querySelectorAll('select[name="type[]"]').forEach(select => {
    select.dispatchEvent(new Event('change'));
});
// Инициализация обработчиков
document.addEventListener('input', (e) => {
    if (e.target.classList.contains('option-input')) {
        updateOptionsJson(e.target.closest('.question-card'));
    }
});
</script>
{% endblock %}