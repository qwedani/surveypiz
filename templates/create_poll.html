{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<div class="poll-editor">
    <h2>Создание нового опроса</h2>
    <form method="POST">
        <div class="form-group">
            <label>Название опроса</label>
            <input type="text" name="title" required>
        </div>

        <div id="questions-container">
            <div class="question-card">
                <div class="question-header">
                    <button type="button" class="delete-btn" onclick="removeQuestion(this)">×</button>
                    <textarea class="question-textarea" name="question[]" placeholder="Текст вопроса" required></textarea>
                    <select name="type[]">
                        <option value="text">Текстовый вопрос</option>
                        <option value="radio">Единичный выбор</option>
                        <option value="checkbox">Множественный выбор</option>
                    </select>
                </div>
                <div class="options-container" style="display: none;">
                    <input type="text" placeholder='Введите варианты в формате JSON: ["Вариант1", "Вариант2"]'
                           name="options[]" class="options-input">
                </div>
            </div>
        </div>

        <button type="button" onclick="addQuestion()" class="btn">Добавить вопрос</button>
        <button type="submit" class="btn">Создать опрос</button>
    </form>
</div>

<script>
// Функция для авто-высоты textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// Инициализация авто-высоты для всех textarea
document.querySelectorAll('.question-textarea').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
    autoResize(textarea); // Инициализация при загрузке
});

// Добавление вопроса
function addQuestion() {
    const newQuestion = `
    <div class="question-card">
        <div class="question-header">
            <button type="button" class="delete-btn" onclick="removeQuestion(this)">×</button>
            <textarea class="question-textarea" name="question[]" placeholder="Текст вопроса" required></textarea>
            <select name="type[]">
                <option value="text">Текстовый вопрос</option>
                <option value="radio">Единичный выбор</option>
                <option value="checkbox">Множественный выбор</option>
            </select>
        </div>
        <div class="options-container" style="display: none;">
            <input type="text" placeholder='Введите варианты в формате JSON: ["Вариант1", "Вариант2"]'
                   name="options[]" class="options-input">
        </div>
    </div>`;

    const container = document.getElementById('questions-container');
    container.insertAdjacentHTML('beforeend', newQuestion);

    // Инициализация авто-высоты для нового поля
    const newTextarea = container.lastElementChild.querySelector('.question-textarea');
    newTextarea.addEventListener('input', () => autoResize(newTextarea));
    autoResize(newTextarea);
}

// Удаление вопроса
function removeQuestion(button) {
    const questionCard = button.closest('.question-card');
    questionCard.remove();
}

// Drag and Drop
document.addEventListener('DOMContentLoaded', function() {
    new Sortable(document.getElementById('questions-container'), {
        animation: 150,
        handle: '.question-card',
        ghostClass: 'dragging-ghost'
    });
});

// Обработчик изменений типа вопроса (делегирование событий)
document.getElementById('questions-container').addEventListener('change', function(e) {
    if (e.target.matches('select[name="type[]"]')) {
        const questionCard = e.target.closest('.question-card');
        const optionsContainer = questionCard.querySelector('.options-container');
        optionsContainer.style.display = ['radio', 'checkbox'].includes(e.target.value)
            ? 'block'
            : 'none';
    }
});

// Инициализация при загрузке
document.querySelectorAll('select[name="type[]"]').forEach(select => {
    select.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}